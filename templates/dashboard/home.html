{% extends "smartmin/base.html" %}
{% load smartmin temba compress i18n humanize tz %}

{% block messages %}
{% endblock messages %}
{% block content %}
  <div class="card scrollable flex-shrink-0" id="range-group">
    <div style="min-height:2.55em"
         class="bg-gray-700 text-gray-400 -mx-6 -mt-6 px-4 py-2 border-b range-header"
         id="range-header">
      <div class="flex opacity-0 transition-opacity" id="message-chart-dates">
        <div class="flex-grow" id="message-chart-range-from"></div>
        <div id="message-chart-range-to"></div>
      </div>
    </div>
    <div id="message-chart"></div>
  </div>
  <div class="card scrollable flex-shrink-0" id="range-group-1">
    <div style="min-height:2.55em"
         class="bg-gray-700 text-gray-400 -mx-6 -mt-6 px-4 py-2 border-b range-header"
         id="range-header">
      <div class="flex opacity-0 transition-opacity chart-dates" id="workspace-chart-dates">
        <div class="flex-grow" id="workspace-chart-range-from"></div>
        <div id="workspace-chart-range-to"></div>
      </div>
    </div>
    <div id="workspace-chart"></div>
  </div>
  <div class="card scrollable flex-shrink-0" id="range-group-2">
    <div id="channel-types-chart"></div>
  </div>
{% endblock content %}
{% block extra-script %}
  {{ block.super }}
  <script type="text/javascript">
    var redrawMarker = null;

    function setChartOptions(chart, begin, end, direction) {
      var chartID = chart.renderTo.id;
      var from = Highcharts.dateFormat('%A, %B %e, %Y', begin);
      var to = Highcharts.dateFormat('%A, %B %e, %Y', end)
      document.querySelector("#" + chartID + "-dates").classList.add("opacity-100");
      document.querySelector("#" + chartID + "-range-from").innerText = from;
      document.querySelector("#" + chartID + "-range-to").innerText = to;
    }

    function selectionChanged(chart) {
      var direction = "";
      if (chart.series[0].visible) {
        direction += "I";
      }

      if (chart.series[1].visible) {
        direction += "O";
      }

      var axis = chart.xAxis[0];
      setChartOptions(chart, axis.min, axis.max, direction);
    }

    function markDirty(chart) {
      if (redrawMarker != null) {
        window.clearTimeout(redrawMarker);
      }
      redrawMarker = window.setTimeout(selectionChanged.bind(null, chart), 200);
    }

    function createChart (container, data) {
      return Highcharts.chart(container, {
        title: {
          text: "Channel types"

        },
        xAxis: {
          tickLength: 0,
          labels: {
              enabled: false
          }
        },
        plotOptions: {
          column: {
              stacking: 'normal'
          }
        },
        tooltip: {
          formatter: function () {
            return this.series.name + ": <b>" + this.y + "</b>";
          }
        },
        series: data,
      })
    }

    function createStockChart(container, data) {
      return Highcharts.stockChart(container, {
        chart: {
          zoomType: 'x',
          events: {
            // mark dirty out the gate
            load: function(e) {
              markDirty(this);
            },
            redraw: function(e) {
              markDirty(this);
            }
          }
        },
        plotOptions: {
          series: {
            showInLegend: true,
            showInNavigator: true,
          },
          column: {
            stacking: 'normal',
          },
          line: {
            cumulative: true,
            tooltip: {
              pointFormat: '{series.name}: <b>{point.cumulativeSum:.0f}</b>'
            }
          }

        },
        legend: {
          enabled: true
        },
        rangeSelector: {
          buttons: [{
            type: 'week',
            count: 1,
            text: 'W'
          }, {
            type: 'month',
            count: 1,
            text: 'M'
          }, {
            type: 'year',
            count: 1,
            text: 'Y'
          }, {
            type: 'all',
            count: 1,
            text: 'all'
          }],
          inputEnabled: false,
          selected: 1
        },
        xAxis: {
          minRange: 3600000 * 24
        },
        credits: {
          enabled: false
        },
        navigator: {
          series: {
            type: 'line'
          }
        },
        series: data
      });
    }

    function loadCharts() {
      Highcharts.setOptions({
        lang: {
          thousandsSep: ','
        }
      });

      var store = document.querySelector("temba-store");
      store.getUrl('/dashboard/message_history').then(function(response) {
        var data = response.json;
        // Create the chart
        createStockChart('message-chart', data);

      });

      store.getUrl('/dashboard/workspace_stats').then(function(response) {
        var data = response.json;
        // Create the chart
        createStockChart('workspace-chart', data);

      });

      store.getUrl('/dashboard/channel_types_stats').then(function(response) {
        var data = response.json;
        // Create the chart
        createChart('channel-types-chart', data);

      });
    }

    onSpload(loadCharts);
  </script>
{% endblock extra-script %}
